<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: cp/cp.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: cp/cp.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>
const path = require('path');
const { spawn } = require('child_process');
const templateParser = require('child-process-template-parser');

/**
 * Node's child_process wrapped in a promise with buffered stdio.
 * @namespace cp
 * @example
 * const { cp } = require('dev-env-lib');
 */
class ChildProcess {

  /**
   * Aggregated output from a child process.
   * @typedef {Object} cp~AggregatedOutput
   * @property {string} output Aggregated stdout and stderr
   * @property {string} stdout Aggregated stdout
   * @property {string} stderr Aggregated stderr
   */

  /**
   * A single path or a sequence of path segments.
   * @typedef {string|string[]} cp~PathSegments
   * @example
   * const singlePath = __dirname;
   * const pathSegments = [__dirname, 'relative/path']
   */

  /**
   * Spawn a new process. Wrap in a promise. Buffer output.
   * @memberOf cp
   * @function spawn
   * @param {cp~PathSegments} options.cwd
   * @param {string} options.command Same as Node's child_process.spawn
   * @param {string[]} [options.args] Same as Node's child_process.spawn
   * @param {Object} [options.nodeSpawnOptions] Node's child_process.spawn options
   * @returns {Promise.&lt;cp~AggregatedOutput>} aggregated output
   * @see [Node's child_process.spawn]{@link https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_spawn_command_args_options}
   */
  spawn(options) {
    options = options || {};
    const args = options.args || [];
    const command = options.command;
    if (!command) return Promise.reject(
      new Error('Missing required option: command'));
    let nodeSpawnOptions = options.nodeSpawnOptions;
    let cwd = options.cwd;
    if (!cwd) return Promise.reject(new Error('Missing required option: cwd'));
    if (cwd instanceof Array) {
      cwd = cwd.reduce((agg, value) => path.resolve(agg, value));
    }
    nodeSpawnOptions = Object.assign({ cwd }, nodeSpawnOptions);
    return new Promise((resolve, reject) => {
      let cp;
      if (args === undefined) cp = spawn(command, nodeSpawnOptions);
      else cp = spawn(command, args, nodeSpawnOptions);
      let output = '';
      let stdout = '';
      let stderr = '';
      cp.stdout.on('data', data => {
        output += data;
        stdout += data;
      });
      cp.stderr.on('data', data => {
        output += data;
        stderr += data;
      });
      cp.on('error', error => {
        reject(error);
      });
      cp.on('close', code => {
        const response = { code, output, stdout, stderr };
        if (code === 0) resolve(response);
        else reject(response);
      });
    });
  }


  /**
   * Spawn a new process using the given template for the command and args.
   * @memberOf cp
   * @function spawnTemplate
   * @param {cp~PathSegments} options.cwd
   * @param {cp~PathSegments} options.templatePath path to template.
   * @param {Object} [options.model] Model object passed into template.
   * @param {Object} [options.nodeSpawnOptions] Node's child_process.spawn options
   * @returns {Promise.&lt;cp~AggregatedOutput>} aggregated output
   * @see [Node's child_process.spawn]{@link https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_spawn_command_args_options}
   */
  spawnTemplate(options) {
    options = options || {};
    let templatePath = options.templatePath;
    if (templatePath instanceof Array) {
      templatePath = templatePath.reduce((agg, value) => {
        return path.resolve(agg, value);
      });
    }
    const model = options.model;
    const nodeSpawnOptions = options.nodeSpawnOptions;
    let cwd = options.cwd;
    if (!cwd) return Promise.reject(
      new Error('Missing required option: cwd'));
    if (cwd instanceof Array) {
      cwd = cwd.reduce((agg, value) => {
        return path.resolve(agg, value);
      });
    }
    const { command, args } = templateParser.parse(templatePath, model);
    return this.spawn({ cwd, command, args, nodeSpawnOptions });
  }

}

module.exports = new ChildProcess();
module.exports.ChildProcess = ChildProcess;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="cp.html">cp</a></li><li><a href="docker.html">docker</a></li><li><a href="git.html">git</a></li><li><a href="yaml.html">yaml</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Wed Dec 13 2017 15:39:17 GMT-0800 (PST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
